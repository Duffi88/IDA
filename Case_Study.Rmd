---
title: "Case_Study"
output: html_document
---

```{r Packages, ,include=FALSE}
#Alle Packages
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
```
##Einführung

Um heraus zu finden, welche Fahrzeuge kritisch sind, müssen sowohl die fehlerhaften Einzelteile, als auch die Komponenten, welche diese enthalten oder selber fehlerhaft sind, überprüft werden.

##Funktionen

###Funktion für Überblick über Dataframes
```{r Funktion: First Glance}
  firstGlance <- function(x){
    print(summary(x))
    cat("\n")
    print(str(x))
    cat("\n")
    print(head(x))
    cat("\n")
    print(tail(x))
  }
```
###Funktion für NA Überprüfung

```{r Funktion: NATest}
  NATest <- function(x){
    #print(summarize(group_by(x, Herstellernummer)))
    #print(summarize(group_by(x, Werksnummer)))
    for (i in 1:ncol(x)){
      if (nrow((x[is.na(x[i]),])) > 0){
        print(c("NA's in ",names(x[i])))
        cat("\n")
        print(x[is.na(x[i]),])
        cat("\n")
        cat("\n")
      }
    }
  }
```

##Einzelteile

Zunächst müssen die einzelnen Tabellen der Einzelteile importiert werden, wobei auf die Zeilen und Reihentrennung(Komma o. Semikolon) zu achten ist.
```{r Import: Einzelteil}
  T11 <- read.csv2("Einzelteil_T11.csv", stringsAsFactors = FALSE)
  T14 <- read.csv2("Einzelteil_T14.csv", stringsAsFactors = FALSE)
  T15 <- read.csv2("Einzelteil_T15.csv", stringsAsFactors = FALSE)
  T16 <- read.csv("Einzelteil_T16.csv", stringsAsFactors = FALSE)
  T19 <- read.csv("Einzelteil_T19.csv", stringsAsFactors = FALSE)
  T20 <- read.csv2("Einzelteil_T20.csv", stringsAsFactors = FALSE)
```
  
###T11
```{r}
firstGlance(T11)
NATest(T11)
```
Keine Auffälligkeiten außer Datumsformat in Character
```{r}
T11.new <- T11
T11.new$Produktionsdatum <- as.Date(T11$Produktionsdatum, format = "%Y-%m-%d")
```

###T14
```{r}
firstGlance(T14)
NATest(T14)
```
Keine Auffälligkeiten außer Datumsformat in Character
```{r}
T14.new <- T14
T14.new$Produktionsdatum <- as.Date(T14$Produktionsdatum, format = "%Y-%m-%d")
```

###T15
```{r}
firstGlance(T15)
NATest(T15)
```
Falsches Datumsformat
```{r}
T15.new <- T15
names(T15.new) <- names(T14)
T15.new$Produktionsdatum <-  as.Date(format(as.Date(T15.new$Produktionsdatum, format = "%d.%m.%Y"), "%Y-%m-%d"))
```

###T16
```{r}
firstGlance(T16)
NATest(T16)
```
Falsches Datumsformat, mit Origin angegeben
```{r}
T16.new <- T16 %>%
    select(1:6)

T16.new$Produktionsdatum <- as.Date(T16.new$Produktionsdatum, format = "%d",origin = as.Date("1970-01-01", format="%Y-%m-%d"))
T16.new <- select(T16.new,1:6)
names(T16.new) <- names(T14)
```

###T19
```{r}
firstGlance(T19)
```
Zeilen sind zum Teil nebeneinander gerutscht
```{r}
T19.1 <- select(T19[!is.na(T19$IDNummer),],1:6) 
T19.2 <- select(T19[!is.na(T19$IDNummer1),],7:12)
names(T19.2) <- names(T19.1)
```
Betrachtung der einzelnen Tabellen
```{r}
firstGlance(T19.1)
NATest(T19.1)

firstGlance(T19.2)
NATest(T19.2)
```
IDNummern sind jeweils falsch
```{r warning=FALSE}
T19.2sep <- T19.2 %>%
  separate(IDNummer, c("BT","Herst","Werk","X"), sep = c("-","-","-")) 
T19.2sep$BT <- 19
T19.2uni <- T19.2sep%>%
  unite(col = IDNummer, BT, Herstellernummer, Werksnummer, X, sep = c("-","-","-"),remove = FALSE)%>%
  select( X1,IDNummer,Produktionsdatum,Herstellernummer,Werksnummer,Fehlerhaft)
  

T19.1sep <- T19.1%>%
  separate(IDNummer, c("BT","Rest"),sep = c("-"), extra = "merge")
T19.1sep$BT <- 19
T19.1uni <- T19.1sep%>%
  unite(col = IDNummer, BT, Rest, sep = c("-"))%>%
  select(X1,IDNummer,Produktionsdatum,Herstellernummer,Werksnummer,Fehlerhaft)
  
T19.new <- arrange(bind_rows(T19.1uni,T19.2uni),X1)
names(T19.new) <- names(T14)
```

###T20
```{r}
firstGlance(T20)
NATest(T20)
```
Falsches Datumsformat und NA's
```{r}
T20.new <- T20
T20.new$Produktionsdatum <-  as.Date(format(as.Date(T20$Produktionsdatum, format = "%d.%m.%Y"), "%Y-%m-%d"))

T20.new$Fehlerhaft[T20$IDNummer == "20-209-2091-96178"] <- 1
T20.new$X[T20$IDNummer == "20-209-2091-96178"] <- 163764
T20.new$Herstellernummer[T20$X == 699] <- 211
T20.new$Werksnummer[T20$X == 129019] <- 2111
```

###Fehlerhafte Teile

```{r}
T11F <- T11.new %>%
  filter(Fehlerhaft == 1)%>%
  select(2:3)
T14F <- T14.new %>%
 filter(Fehlerhaft == 1)%>%
  select(2:3)
T15F <- T15.new %>%
 filter(Fehlerhaft == 1)%>%
  select(2:3)
T16F <- T16.new %>%
  filter(Fehlerhaft == 1) %>%
  select(2:3)
T19F <- T19.new %>%
  filter(Fehlerhaft == 1) %>%
  select(2:3)
T20F <- T20.new %>%
  filter(Fehlerhaft == 1) %>%
  select(2:3)
```
```{r include=FALSE}
names(T11F) <- c("ID_T11","T11_Datum")
names(T14F) <- c("ID_T14","T14_Datum")
names(T15F) <- c("ID_T15","T15_Datum")
names(T16F) <- c("ID_T16","T16_Datum")
names(T19F) <- c("ID_T19","T19_Datum")
names(T20F) <- c("ID_T20","T20_Datum")
```
Auffälligkeiten
```{r}
nrow(T11F)
nrow(T14F)
nrow(T15F)
nrow(T16F)
nrow(T19F)
nrow(T20F)
```
Bei T15 und T20 sehr viele fehlerhafte Teile

```{r}
T15G <- aggregate(T15.new$Fehlerhaft, by=list(Produktionsdatum=T15.new$Produktionsdatum), FUN=sum)
T20G <- aggregate(T20.new$Fehlerhaft, by=list(Produktionsdatum=T20.new$Produktionsdatum), FUN=sum)

T15GC <- count(T15.new,Produktionsdatum)
T15FC <- count(T15F,T15_Datum)
T15CC <- left_join(T15GC,T15FC, by = c("Produktionsdatum" = "T15_Datum" ))
T15CC[is.na(T15CC[,3]),3] <- 0

#Plot um Fehlerverlauf zu zeigen
ggplot(T15CC, aes(x = Produktionsdatum))+
  geom_bar(stat = "identity",aes(y = n.x, col = "red", fill = "red"))+
  geom_bar(stat = "identity",aes(y = n.y, col = "blue", fill = "blue"))+
  scale_fill_discrete(name = "T15 Lieferung", labels = c("Fehlerhaft","Fehlerfrei"))+
  guides(color = FALSE)

T20GC <- count(T20.new,Produktionsdatum)
T20FC <- count(T20F,T20_Datum)
T20CC <- left_join(T20GC,T20FC, by = c("Produktionsdatum" = "T20_Datum" ))
T20CC[is.na(T20CC[,3]),3] <- 0

#Plot um Fehlerverlauf zu zeigen
ggplot(T20CC, aes(x = Produktionsdatum))+
  geom_bar(stat = "identity",aes(y = n.x, col = "red", fill = "red"))+
  geom_bar(stat = "identity",aes(y = n.y, col = "blue", fill = "blue"))+
  scale_fill_discrete(name = "T20 Produktion", labels = c("Fehlerhaft","Fehlerfrei"))+
  guides(color = FALSE)

#Fehleranteile der Werke
ggplot(T15.new, aes(x = as.factor(Werksnummer), fill = as.factor(Fehlerhaft)))+
  geom_bar(position = "fill")+
  scale_fill_manual(name = "Fehlerhaft",values = c("#00BFC4","#F8766D"))+
  ggtitle("Prozentualer Anteil Fehlerhafter Teile pro Werk - T 15")+
  xlab("Werksnummer")+
  ylab("Prozent. Anteil")

#Fehleranteile der Werke
ggplot(T20.new, aes(x = as.factor(Werksnummer), fill = as.factor(Fehlerhaft)))+
  geom_bar(position = "fill")+
  scale_fill_manual(name = "Fehlerhaft",values = c("#00BFC4","#F8766D"))+
  ggtitle("Prozentualer Anteil Fehlerhafter Teile pro Werk - T 20")+
  xlab("Werksnummer")+
  ylab("Prozent. Anteil")


```

##Komponenten

Es müssen alle Komponenten herausgefiltert werden, die beschädigt sind oder in denen fehlerhafte Teile verbaut sind.

```{r}
path.K2LE1B <- "Bestandteile_Komponente_K2LE1.csv" 
path.K2LE2B <- "Bestandteile_Komponente_K2LE2.csv" 
path.K2LE1 <- "Komponente_K2LE1.csv" 
path.K2LE2 <- "Komponente_K2LE1.csv" 

K2LE1B <- read.csv2(path.K2LE1B, stringsAsFactors = FALSE)
K2LE2B <- read.csv2(path.K2LE2B, stringsAsFactors = FALSE)
K2LE1 <- read.csv2(path.K2LE1, stringsAsFactors = FALSE)
K2LE2 <- read.csv2(path.K2LE2, stringsAsFactors = FALSE)
```

```{r}
firstGlance(K2LE2)
```
IDNummer Fehlerhaft          

```{r}
K2LE2.sep <- K2LE2%>%
  separate(IDNummer, c("KK","Rest"),sep = c("-"), extra = "merge")
K2LE2.sep$KK <- "K2LE2"
K2LE2.new <- unite(K2LE2.sep,col = IDNummer, KK, Rest, sep = c("-"))

```
```{r}
#K(omponente K2LE)1 J(oined with T)X

K1J11 <- select(K2LE1B,2,5)%>%
  inner_join(T11F,by = "ID_T11")
K1J14 <- select(K2LE1B,3,5)%>%
  inner_join(T14F,by = "ID_T14")
K1J15 <- select(K2LE1B,4,5)%>%
  inner_join(T15F,by = "ID_T15")
K2J16 <- select(K2LE2B,3,6)%>%
  inner_join(T16F,by = "ID_T16")
K2J19 <- select(K2LE2B,4,6)%>%
  inner_join(T19F,by = "ID_T19")
K2J20 <- select(K2LE2B,5,6)%>%
  inner_join(T20F,by = "ID_T20")

#Komponente Full Join
K1JF <- full_join(K1J11,K1J14, by = "ID_K2LE1")%>%
  full_join(K1J15, by = "ID_K2LE1")%>%
  full_join(K2LE1[K2LE1$Fehlerhaft == 1,2:3], by = c("ID_K2LE1"="IDNummer"))

K2JF <- full_join(K2J16,K2J19, by = "ID_K2LE2")%>%
  full_join(K2J20, by = "ID_K2LE2")%>%
  full_join(K2LE2.new[K2LE2.new$Fehlerhaft == 1,2:3], by = c("ID_K2LE2"="IDNummer"))

KJF <- full_join(K2JF,K1JF,by = c("ID_K2LE2" = "ID_K2LE1"))

head(KJF)
```

##Fahrzeuge

```{r}

path.OEM11B <- "Bestandteile_Fahrzeuge_OEM1_Typ11.csv" 
path.OEM12B <- "Bestandteile_Fahrzeuge_OEM1_Typ12.csv" 
path.OEM21B <- "Bestandteile_Fahrzeuge_OEM2_Typ21.csv" 
path.OEM22B <- "Bestandteile_Fahrzeuge_OEM2_Typ22.csv" 
path.OEM11 <- "Fahrzeuge_OEM1_Typ11.csv" 
path.OEM12 <- "Fahrzeuge_OEM1_Typ12.csv" 
path.OEM21 <- "Fahrzeuge_OEM2_Typ21.csv" 
path.OEM22 <- "Fahrzeuge_OEM2_Typ22.csv" 

OEM11B <- read.csv2(path.OEM11B, stringsAsFactors = FALSE)
OEM12B <- read.csv2(path.OEM12B, stringsAsFactors = FALSE)
OEM21B <- read.csv2(path.OEM21B, stringsAsFactors = FALSE)
OEM22B <- read.csv2(path.OEM22B, stringsAsFactors = FALSE)
OEM11 <- read.csv2(path.OEM11, stringsAsFactors = FALSE)
OEM12 <- read.csv2(path.OEM12, stringsAsFactors = FALSE)
OEM21 <- read.csv2(path.OEM21, stringsAsFactors = FALSE)
OEM22 <- read.csv2(path.OEM22, stringsAsFactors = FALSE)

```

Fahrzeuge mit kritischen Komponenten

```{r message=FALSE, warning=FALSE}
OEM11BF <- inner_join(OEM11B,KJF, by = c("ID_Sitze" = "ID_K2LE2"))%>%
  select(4,6)

OEM12BF <- inner_join(OEM12B,KJF, by = c("ID_Sitze" = "ID_K2LE2"))%>%
  select(4,6)

OEM21BF <- inner_join(OEM21B,KJF, by = c("ID_Sitze" = "ID_K2LE2"))%>%
  select(5,7)

OEM22BF <- inner_join(OEM22B,KJF, by = c("ID_Sitze" = "ID_K2LE2"))%>%
  select(5,7)


OEMF <- full_join(OEM11BF,OEM12BF)%>%
  full_join(OEM21BF)%>%
  full_join(OEM22BF)

head(OEMF)
```

##Zulassung & Geodaten

```{r}
Zul_aller <- read.csv2("Zulassungen_alle_Fahrzeuge.csv", stringsAsFactors = FALSE)
Geo <- read.csv2("Geodaten_Gemeinden.csv", stringsAsFactors = FALSE)
Geo.new <- Geo%>%
  select(3:6)
Zul_aller.new <- Zul_aller%>%
  select(2:4)

GesTab <- left_join(OEMF,Zul_aller.new, by =c("ID_Fahrzeug" = "IDNummer"))%>%
  left_join(Geo.new, by = c("Gemeinden" = "Gemeinde"))

head(GesTab)
```